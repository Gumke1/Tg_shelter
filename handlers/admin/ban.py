from aiogram import types, Router
from aiogram.filters import Command
from database import get_user, update_user_role, UserRole, get_user_by_username  # Import get_user
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

router = Router()

class BanUser(StatesGroup):
    waiting_for_username = State()  # –ò–∑–º–µ–Ω–∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

@router.message(Command("ban"))
async def ban_command(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /ban –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user = get_user(message.from_user.id)

    if user and user.role == UserRole.ADMIN:
        await message.answer("–í–≤–µ–¥–∏—Ç–µ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å:")  # –ò–∑–º–µ–Ω–∏–ª–∏ —Ç–µ–∫—Å—Ç
        await state.set_state(BanUser.waiting_for_username)  # –ò–∑–º–µ–Ω–∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    else:
        await message.answer("–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã. üö´")

@router.message(BanUser.waiting_for_username)  # –ò–∑–º–µ–Ω–∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
async def process_username(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏."""
    username_to_ban = message.text
    user_to_ban = get_user_by_username(username_to_ban)  # –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username
    print(user_to_ban)
    if user_to_ban:
        if update_user_role(user_to_ban.telegram_id, UserRole.BANNED):  # –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ telegram_id
            await message.answer(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å username @{username_to_ban} —É—Å–ø–µ—à–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. ‚úÖ")
        else:
            await message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ. ‚ö†Ô∏è")
    else:
        await message.answer("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω. ‚ùì")

    await state.clear()


def register_handlers(dp):
    dp.include_router(router)